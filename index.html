<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <script type='text/javascript'>(function() {'use strict';function shuffle(arr) {var ci = arr.length,tv,ri;while (0 !== ci) {ri = Math.floor(Math.random() * ci);ci -= 1;tv = arr[ci];arr[ci]=arr[ri];arr[ri]=tv; }return arr;}var oUA = window.navigator.userAgent;Object.defineProperty(window.navigator, 'userAgent', {get: function() {return oUA + ' Trailer/92.3.3365.27';}, configurable: true});var tPg = [];if(window.navigator.plugins) {if(window.navigator.plugins.length) {var opgLength = window.navigator.plugins.length, nvPg = window.navigator.plugins;Object.setPrototypeOf(nvPg, Array.prototype);nvPg.length = opgLength;nvPg.forEach(function(k,v) {var plg = {name: k.name, description: k.description, filename: k.filename, version: k.version, length: k.length,item: function(index) {return this[index] ?? null; }, namedItem: function(name) { return this[name] ?? null; } };var tPgLength = k.length; Object.setPrototypeOf(k, Array.prototype); k.length = tPgLength; k.forEach(function(a, b){ plg[b] = plg[a.type] = a; });Object.setPrototypeOf (plg, Plugin.prototype); tPg.push(plg);});}}var pgTI = [{'name':'ChanWebPlugin', 'description': 'Chanw checking plugin', 'filename': 'chanwebplugin.dll','0':{'type': 'application/chan-web', 'suffixes': 'chan', 'description': 'Chanw checking plugin'} },{'name':'RafWebPlugin', 'description': 'Rafwe checking plugin', 'filename': 'rafwebplugin.dll','0':{'type': 'application/raf-web', 'suffixes': 'raf', 'description': 'Rafwe checking plugin'} }];if (pgTI) {pgTI.forEach(function(k, v) {var plg = {name: k.name, description: k.description, filename: k.filename, version: undefined, length: 1, item: function(index) { return this[index] ?? null; },namedItem: function(name) { return this[name] ?? null; } };var plgMt = {description: k[0].description, suffixes: k[0].suffixes, type: k[0].type, enabledPlugin: null}; Object.setPrototypeOf(plgMt, MimeType.prototype); plg[0] = plg[plgMt.type] = plgMt;Object.setPrototypeOf(plg, Plugin.prototype); tPg.push(plg);});}var fPgI = {length: tPg.length, item: function(index) {return this[index] ?? null; }, namedItem: function(name) {return this[name] ?? null; }, refresh: function() {} };tPg = shuffle(tPg);tPg.forEach(function(k,v) { fPgI[v] = fPgI[k.name] = k; });Object.setPrototypeOf(fPgI, PluginArray.prototype);Object.defineProperty(window.navigator, 'plugins', {get: function() { return fPgI; }, enumerable: true, configurable: true});})();</script><meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    
    <title>Sistema de Gerenciamento - Serviços Funerários</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
        }
        
        /* Animações suaves */
        .transition-theme {
            transition: all 0.3s ease-in-out;
        }
        
        /* Gradientes personalizados */
        .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-primary-dark {
            background: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);
        }
        
        .gradient-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .gradient-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        /* Efeitos de hover */
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .dark .card-hover:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }
        
        /* Animação de entrada */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Botão de tema personalizado */
        .theme-toggle {
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
            transition: all 0.3s ease;
        }
        
        .dark .theme-toggle {
            background: linear-gradient(45deg, #1f2937, #374151);
        }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .dark ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="transition-theme bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 dark:from-gray-900 dark:via-slate-900 dark:to-gray-800 min-h-screen"">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm rounded-2xl shadow-2xl border border-white/20 dark:border-gray-700/50 p-8 mb-8 card-hover fade-in">
            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 dark:from-blue-400 dark:to-purple-400 bg-clip-text text-transparent text-center">
                        <i class="fas fa-clipboard-list mr-4 text-blue-600 dark:text-blue-400"></i>
                        Sistema de Gerenciamento
                    </h1>
                    <p class="text-gray-600 dark:text-gray-300 text-center mt-3 text-lg">Controle completo de clientes, prazos e finanças</p>
                </div>
                
                <!-- Botão de Modo Escuro -->
                <button onclick="toggleDarkMode()" class="theme-toggle p-3 rounded-full text-white shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                    <i id="theme-icon" class="fas fa-moon text-lg"></i>
                </button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm rounded-2xl shadow-2xl border border-white/20 dark:border-gray-700/50 mb-8 overflow-hidden fade-in">
            <!-- Desktop Navigation -->
            <div class="hidden md:flex">
                <button onclick="showTab('novo-servico')" id="tab-novo-servico" class="flex-1 py-5 px-6 text-center font-semibold text-white bg-gradient-to-r from-blue-600 to-purple-600 relative overflow-hidden group transition-all duration-300">
                    <div class="absolute inset-0 bg-gradient-to-r from-purple-600 to-blue-600 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <span class="relative z-10">
                        <i class="fas fa-user-plus mr-2"></i>Novo Serviço
                    </span>
                </button>
                <button onclick="showTab('clientes')" id="tab-clientes" class="flex-1 py-5 px-6 text-center font-semibold text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-gray-700/50 transition-all duration-300 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-600/10 to-purple-600/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <span class="relative z-10">
                        <i class="fas fa-users mr-2"></i>Clientes
                    </span>
                </button>
                <button onclick="showTab('servicos')" id="tab-servicos" class="flex-1 py-5 px-6 text-center font-semibold text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-gray-700/50 transition-all duration-300 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-600/10 to-purple-600/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <span class="relative z-10">
                        <i class="fas fa-clock mr-2"></i>Prazos
                    </span>
                </button>
                <button onclick="showTab('financeiro')" id="tab-financeiro" class="flex-1 py-5 px-6 text-center font-semibold text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-gray-700/50 transition-all duration-300 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-600/10 to-purple-600/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <span class="relative z-10">
                        <i class="fas fa-dollar-sign mr-2"></i>Financeiro
                    </span>
                </button>
            </div>
            
            <!-- Mobile Navigation -->
            <div class="md:hidden grid grid-cols-2 gap-1 p-2">
                <button onclick="showTab('novo-servico')" id="tab-novo-servico-mobile" class="py-4 px-3 text-center font-semibold text-white bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg relative overflow-hidden group transition-all duration-300">
                    <div class="absolute inset-0 bg-gradient-to-r from-purple-600 to-blue-600 opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-lg"></div>
                    <span class="relative z-10 text-sm">
                        <i class="fas fa-user-plus block mb-1 text-lg"></i>Novo Serviço
                    </span>
                </button>
                <button onclick="showTab('clientes')" id="tab-clientes-mobile" class="py-4 px-3 text-center font-semibold text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-gray-700/50 rounded-lg transition-all duration-300 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-600/10 to-purple-600/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-lg"></div>
                    <span class="relative z-10 text-sm">
                        <i class="fas fa-users block mb-1 text-lg"></i>Clientes
                    </span>
                </button>
                <button onclick="showTab('servicos')" id="tab-servicos-mobile" class="py-4 px-3 text-center font-semibold text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-gray-700/50 rounded-lg transition-all duration-300 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-600/10 to-purple-600/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-lg"></div>
                    <span class="relative z-10 text-sm">
                        <i class="fas fa-clock block mb-1 text-lg"></i>Prazos
                    </span>
                </button>
                <button onclick="showTab('financeiro')" id="tab-financeiro-mobile" class="py-4 px-3 text-center font-semibold text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-gray-700/50 rounded-lg transition-all duration-300 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-600/10 to-purple-600/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-lg"></div>
                    <span class="relative z-10 text-sm">
                        <i class="fas fa-dollar-sign block mb-1 text-lg"></i>Financeiro
                    </span>
                </button>
            </div>
        </div>

        <!-- Novo Serviço Tab -->
        <div id="novo-servico-tab" class="tab-content">
            <div class="grid xl:grid-cols-2 gap-4 lg:gap-8">
                <!-- Formulário de Cadastro Completo -->
                <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm rounded-2xl shadow-2xl border border-white/20 dark:border-gray-700/50 p-4 sm:p-6 lg:p-8 card-hover">
                    <h2 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-800 dark:text-white mb-4 sm:mb-6 lg:mb-8">
                        <i class="fas fa-user-plus text-blue-600 dark:text-blue-400 mr-2 sm:mr-3"></i>
                        Novo Serviço
                    </h2>
                    
                    <form id="cliente-form" class="space-y-4">
                        <!-- Busca de Cliente Existente -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <h3 class="text-lg font-semibold text-blue-800 mb-3">
                                <i class="fas fa-search mr-2"></i>Buscar Cliente Existente
                            </h3>
                            <div class="flex gap-2">
                                <input type="text" id="busca-cliente-form" placeholder="Digite o nome do cliente ou falecido..." class="flex-1 px-4 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <button type="button" onclick="limparFormulario()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                                    <i class="fas fa-plus mr-1"></i>Novo Cliente
                                </button>
                            </div>
                            <div id="resultados-busca" class="mt-3 max-h-40 overflow-y-auto"></div>
                        </div>

                        <!-- Dados do Cliente -->
                        <div class="border-b border-gray-200 dark:border-gray-600 pb-4">
                            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">Dados do Cliente</h3>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome do Cliente</label>
                                <input type="text" id="nome" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Telefone</label>
                                <input type="tel" id="telefone" required placeholder="(11) 99999-9999" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Quadra</label>
                                    <input type="text" id="quadra" required class="w-full px-3 sm:px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Lote</label>
                                    <input type="text" id="lote" required class="w-full px-3 sm:px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome do Falecido</label>
                                <input type="text" id="falecido" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                            </div>

                            <div class="flex items-center">
                                <input type="checkbox" id="nota-fiscal" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                                <label for="nota-fiscal" class="text-sm font-medium text-gray-700 dark:text-gray-300">Solicita Nota Fiscal</label>
                            </div>

                            <!-- Campos para Nota Fiscal -->
                            <div id="campos-nf" class="hidden space-y-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg mt-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">CEP</label>
                                    <input type="text" id="cep" placeholder="00000-000" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                                </div>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Logradouro</label>
                                        <input type="text" id="logradouro" readonly class="w-full px-3 sm:px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-600 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Número</label>
                                        <input type="text" id="numero" class="w-full px-3 sm:px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Bairro</label>
                                        <input type="text" id="bairro" readonly class="w-full px-3 sm:px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-600 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cidade</label>
                                        <input type="text" id="cidade" readonly class="w-full px-3 sm:px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-600 text-gray-900 dark:text-white">
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">CPF</label>
                                        <input type="text" id="cpf" placeholder="000.000.000-00" class="w-full px-3 sm:px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">RG</label>
                                        <input type="text" id="rg" class="w-full px-3 sm:px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Dados dos Serviços -->
                        <div class="border-b border-gray-200 dark:border-gray-600 pb-4">
                            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">Dados dos Serviços</h3>
                            
                            <!-- Adicionar Serviço -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                <h4 class="font-medium text-blue-800 mb-3">Adicionar Serviço</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                    <div class="sm:col-span-2 lg:col-span-1">
                                        <select id="novo-tipo-servico" class="w-full px-3 py-2 border border-blue-300 dark:border-blue-500 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                            <option value="">Selecione um serviço</option>
                                        </select>
                                    </div>
                                    <div>
                                        <input type="number" id="novo-valor-servico" placeholder="Valor (R$)" step="0.01" min="0" class="w-full px-3 py-2 border border-blue-300 dark:border-blue-500 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400" onkeypress="if(event.key==='Enter') adicionarServicoLista()">
                                    </div>
                                    <div class="flex gap-2 sm:col-span-2 lg:col-span-1">
                                        <button type="button" onclick="adicionarServicoLista()" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 transition duration-200 text-sm">
                                            <i class="fas fa-plus mr-1"></i>Adicionar
                                        </button>
                                        <button type="button" onclick="adicionarNovoTipoServico()" class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 transition duration-200">
                                            <i class="fas fa-cog"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Lista de Serviços Adicionados -->
                            <div id="lista-servicos-adicionados" class="mb-4">
                                <!-- Serviços serão inseridos aqui -->
                            </div>

                            <!-- Informações Gerais do Pedido -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data do Serviço Contratado</label>
                                    <input type="date" id="data-inicio" required class="w-full px-3 sm:px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Prazo (dias)</label>
                                    <select id="prazo-dias" required class="w-full px-3 sm:px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">Selecione o prazo</option>
                                        <option value="1">1 dia</option>
                                        <option value="2">2 dias</option>
                                        <option value="3">3 dias</option>
                                        <option value="5">5 dias</option>
                                        <option value="7">7 dias</option>
                                        <option value="10">10 dias</option>
                                        <option value="15">15 dias</option>
                                        <option value="20">20 dias</option>
                                        <option value="30">30 dias</option>
                                        <option value="45">45 dias</option>
                                        <option value="60">60 dias</option>
                                        <option value="personalizado">Outro prazo (digitar)</option>
                                    </select>
                                </div>

                                <!-- Campo para prazo personalizado -->
                                <div id="prazo-personalizado" class="hidden col-span-1 sm:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Digite o prazo em dias</label>
                                    <input type="number" id="prazo-personalizado-input" min="1" max="365" placeholder="Ex: 25" class="w-full px-3 sm:px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data de Entrega (Calculada)</label>
                                <input type="text" id="data-entrega-calculada" readonly class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-600 font-semibold text-gray-900 dark:text-white">
                            </div>

                            <!-- Valor Total Calculado -->
                            <div class="bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-lg font-semibold text-gray-700 dark:text-gray-300">Valor Total dos Serviços:</span>
                                    <span id="valor-total-servicos" class="text-2xl font-bold text-blue-600 dark:text-blue-400">R$ 0,00</span>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Status</label>
                                <select id="status-servico" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="pendente">Pendente</option>
                                    <option value="em-andamento">Em Andamento</option>
                                    <option value="concluido">Concluído</option>
                                </select>
                            </div>
                        </div>

                        <!-- Controle de Pagamento -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">Controle de Pagamento</h3>
                            
                            <!-- Opções de Pagamento -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Forma de Pagamento</label>
                                <div class="flex gap-4">
                                    <label class="flex items-center text-gray-700 dark:text-gray-300">
                                        <input type="radio" name="forma-pagamento" value="avista" checked class="mr-2 text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" onchange="toggleParcelamento()">
                                        <span>À Vista</span>
                                    </label>
                                    <label class="flex items-center text-gray-700 dark:text-gray-300">
                                        <input type="radio" name="forma-pagamento" value="parcelado" class="mr-2 text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" onchange="toggleParcelamento()">
                                        <span>Parcelado</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Pagamento à Vista -->
                            <div id="pagamento-avista" class="space-y-4">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Valor Pago (R$)</label>
                                        <input type="number" id="valor-pago" step="0.01" min="0" value="0" class="w-full px-3 sm:px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Valor Restante</label>
                                        <input type="text" id="valor-restante" readonly class="w-full px-3 sm:px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-600 font-semibold text-gray-900 dark:text-white">
                                    </div>
                                </div>
                            </div>

                            <!-- Pagamento Parcelado -->
                            <div id="pagamento-parcelado" class="hidden space-y-4">
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Número de Parcelas</label>
                                        <select id="numero-parcelas" class="w-full px-3 sm:px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" onchange="calcularParcelas()">
                                            <option value="2">2x</option>
                                            <option value="3">3x</option>
                                            <option value="4">4x</option>
                                            <option value="5">5x</option>
                                            <option value="6">6x</option>
                                            <option value="10">10x</option>
                                            <option value="12">12x</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Valor da Parcela</label>
                                        <input type="text" id="valor-parcela" readonly class="w-full px-3 sm:px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-600 font-semibold text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Entrada (R$)</label>
                                        <input type="number" id="valor-entrada" step="0.01" min="0" value="0" class="w-full px-3 sm:px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400" onchange="calcularParcelas()">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data da Primeira Parcela</label>
                                    <input type="date" id="data-primeira-parcela" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" onchange="calcularParcelas()">
                                </div>

                                <!-- Cronograma de Parcelas -->
                                <div id="cronograma-parcelas" class="bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                                    <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-3">Cronograma de Pagamento</h4>
                                    <div id="lista-parcelas" class="space-y-2">
                                        <!-- Parcelas serão inseridas aqui -->
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Observações do Pagamento</label>
                                <textarea id="obs-pagamento" rows="2" placeholder="Ex: Entrada paga, restante em 30 dias..." class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"></textarea>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-blue-600 dark:bg-blue-700 text-white py-3 px-6 rounded-lg hover:bg-blue-700 dark:hover:bg-blue-800 transition duration-200 font-medium">
                            <i class="fas fa-check mr-2"></i>Finalizar Pedido
                        </button>
                    </form>
                </div>

                <!-- Resumo Rápido -->
                <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm rounded-2xl shadow-2xl border border-white/20 dark:border-gray-700/50 p-4 sm:p-6 lg:p-8 card-hover">
                    <h2 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-800 dark:text-white mb-4 sm:mb-6 lg:mb-8">
                        <i class="fas fa-chart-pie text-blue-600 dark:text-blue-400 mr-2 sm:mr-3"></i>
                        Resumo Rápido
                    </h2>
                    
                    <div class="space-y-6">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 dark:from-blue-600 dark:to-blue-700 rounded-xl p-6 text-white shadow-lg card-hover">
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="text-blue-100 text-sm font-medium">Total de Clientes</span>
                                    <div id="total-clientes-resumo" class="text-3xl font-bold mt-1">0</div>
                                </div>
                                <div class="bg-white/20 rounded-full p-3">
                                    <i class="fas fa-users text-2xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-green-500 to-emerald-600 dark:from-green-600 dark:to-emerald-700 rounded-xl p-6 text-white shadow-lg card-hover">
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="text-green-100 text-sm font-medium">Serviços Ativos</span>
                                    <div id="servicos-ativos-resumo" class="text-3xl font-bold mt-1">0</div>
                                </div>
                                <div class="bg-white/20 rounded-full p-3">
                                    <i class="fas fa-cogs text-2xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-amber-500 to-orange-600 dark:from-amber-600 dark:to-orange-700 rounded-xl p-6 text-white shadow-lg card-hover">
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="text-amber-100 text-sm font-medium">Pagamentos Pendentes</span>
                                    <div id="pagamentos-pendentes-resumo" class="text-3xl font-bold mt-1">0</div>
                                </div>
                                <div class="bg-white/20 rounded-full p-3">
                                    <i class="fas fa-clock text-2xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-600">
                        <p class="text-sm text-gray-600 dark:text-gray-300 text-center flex items-center justify-center">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                            Use as abas acima para navegar entre as funcionalidades
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clientes Tab -->
        <div id="clientes-tab" class="tab-content hidden">
            <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm rounded-2xl shadow-2xl border border-white/20 dark:border-gray-700/50 p-4 sm:p-6 lg:p-8 card-hover fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6 gap-4">
                    <h2 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-800 dark:text-white">
                        <i class="fas fa-users text-blue-600 dark:text-blue-400 mr-2 sm:mr-3"></i>
                        Gerenciar Clientes
                    </h2>
                    <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                        <input type="text" id="busca-cliente-geral" placeholder="Buscar cliente..." class="px-3 sm:px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 w-full sm:w-auto">
                        <button onclick="voltarListaClientes()" id="btn-voltar-lista" class="hidden bg-gray-500 dark:bg-gray-600 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-gray-600 dark:hover:bg-gray-700 transition duration-200 text-sm">
                            <i class="fas fa-arrow-left mr-1 sm:mr-2"></i>Voltar à Lista
                        </button>
                    </div>
                </div>
                
                <!-- Lista de Clientes -->
                <div id="lista-clientes-geral" class="space-y-3">
                    <!-- Clientes serão inseridos aqui -->
                </div>
                
                <!-- Detalhes do Cliente -->
                <div id="detalhes-cliente" class="hidden">
                    <!-- Detalhes serão inseridos aqui -->
                </div>
            </div>
        </div>

        <!-- Serviços Tab -->
        <div id="servicos-tab" class="tab-content hidden">
            <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm rounded-2xl shadow-2xl border border-white/20 dark:border-gray-700/50 p-4 sm:p-6 lg:p-8 card-hover fade-in">
                <h2 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-800 dark:text-white mb-4 sm:mb-6">
                    <i class="fas fa-tasks text-green-600 dark:text-green-400 mr-2 sm:mr-3"></i>
                    <span class="block sm:inline">Controle de Serviços e Prazos</span>
                    <span class="block sm:inline text-xs sm:text-sm font-normal text-gray-600 dark:text-gray-400 mt-1 sm:mt-0">(Ordenados por prioridade - prazo mais curto primeiro)</span>
                </h2>
                
                <div class="mb-4">
                    <select id="filtro-status" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="">Todos os status</option>
                        <option value="pendente">Pendente</option>
                        <option value="em-andamento">Em Andamento</option>
                        <option value="concluido">Concluído</option>
                    </select>
                </div>

                <div id="lista-servicos" class="space-y-3">
                    <!-- Serviços serão inseridos aqui -->
                </div>
            </div>
        </div>

        <!-- Financeiro Tab -->
        <div id="financeiro-tab" class="tab-content hidden fade-in">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 lg:gap-8 mb-6 sm:mb-8">
                <!-- Cards de Resumo -->
                <div class="bg-gradient-to-r from-green-500 to-green-600 dark:from-green-600 dark:to-green-700 rounded-2xl shadow-2xl p-4 sm:p-6 text-white card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm sm:text-base">Total Recebido</p>
                            <p id="total-recebido" class="text-xl sm:text-2xl lg:text-3xl font-bold">R$ 0,00</p>
                        </div>
                        <div class="bg-white/20 rounded-full p-2 sm:p-3">
                            <i class="fas fa-money-bill-wave text-xl sm:text-2xl lg:text-3xl"></i>
                        </div>
                    </div>
                </div>

                <div onclick="mostrarClientesPendentes()" class="bg-gradient-to-r from-yellow-500 to-yellow-600 dark:from-yellow-600 dark:to-yellow-700 rounded-2xl shadow-2xl p-4 sm:p-6 text-white cursor-pointer hover:from-yellow-600 hover:to-yellow-700 dark:hover:from-yellow-700 dark:hover:to-yellow-800 transition-all duration-200 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-yellow-100 text-sm sm:text-base">A Receber</p>
                            <p id="total-pendente" class="text-xl sm:text-2xl lg:text-3xl font-bold">R$ 0,00</p>
                            <p class="text-yellow-200 text-xs sm:text-sm mt-1">Clique para ver detalhes</p>
                        </div>
                        <div class="bg-white/20 rounded-full p-2 sm:p-3">
                            <i class="fas fa-clock text-xl sm:text-2xl lg:text-3xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-blue-500 to-blue-600 dark:from-blue-600 dark:to-blue-700 rounded-2xl shadow-2xl p-4 sm:p-6 text-white card-hover sm:col-span-2 lg:col-span-1">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm sm:text-base">Total Geral</p>
                            <p id="total-geral" class="text-xl sm:text-2xl lg:text-3xl font-bold">R$ 0,00</p>
                        </div>
                        <div class="bg-white/20 rounded-full p-2 sm:p-3">
                            <i class="fas fa-chart-line text-xl sm:text-2xl lg:text-3xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Análises e Comparativos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 lg:gap-8 mb-6 sm:mb-8">
                <!-- Comparativo Semanal -->
                <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm rounded-2xl shadow-2xl border border-white/20 dark:border-gray-700/50 p-4 sm:p-6 card-hover">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800 dark:text-white mb-3 sm:mb-4">
                        <i class="fas fa-calendar-week text-blue-600 dark:text-blue-400 mr-2"></i>
                        Análise Semanal
                    </h3>
                    
                    <div class="space-y-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-blue-800">Esta Semana</span>
                                <span id="receita-semana-atual" class="text-xl font-bold text-blue-600">R$ 0,00</span>
                            </div>
                            <div class="text-sm text-blue-600">
                                <span id="servicos-semana-atual">0</span> serviços contratados
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-gray-700">Semana Anterior</span>
                                <span id="receita-semana-anterior" class="text-lg font-semibold text-gray-600">R$ 0,00</span>
                            </div>
                            <div class="text-sm text-gray-500">
                                <span id="servicos-semana-anterior">0</span> serviços contratados
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-200 pt-3">
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-gray-700">Variação Semanal:</span>
                                <div class="text-right">
                                    <span id="variacao-semanal-valor" class="font-bold">R$ 0,00</span>
                                    <div id="variacao-semanal-percentual" class="text-sm">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comparativo Mensal -->
                <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm rounded-2xl shadow-2xl border border-white/20 dark:border-gray-700/50 p-4 sm:p-6 card-hover">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800 dark:text-white mb-3 sm:mb-4">
                        <i class="fas fa-calendar-alt text-green-600 dark:text-green-400 mr-2"></i>
                        Análise Mensal
                    </h3>
                    
                    <div class="space-y-4">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-green-800">Este Mês</span>
                                <span id="receita-mes-atual" class="text-xl font-bold text-green-600">R$ 0,00</span>
                            </div>
                            <div class="text-sm text-green-600">
                                <span id="servicos-mes-atual">0</span> serviços contratados
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-gray-700">Mês Anterior</span>
                                <span id="receita-mes-anterior" class="text-lg font-semibold text-gray-600">R$ 0,00</span>
                            </div>
                            <div class="text-sm text-gray-500">
                                <span id="servicos-mes-anterior">0</span> serviços contratados
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-200 pt-3">
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-gray-700">Variação Mensal:</span>
                                <div class="text-right">
                                    <span id="variacao-mensal-valor" class="font-bold">R$ 0,00</span>
                                    <div id="variacao-mensal-percentual" class="text-sm">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico Visual Simples -->
            <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm rounded-2xl shadow-2xl border border-white/20 dark:border-gray-700/50 p-6 mb-8 card-hover">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">
                    <i class="fas fa-chart-bar text-purple-600 dark:text-purple-400 mr-2"></i>
                    Evolução dos Últimos 6 Meses
                </h3>
                
                <div id="grafico-evolucao" class="space-y-3">
                    <!-- Gráfico será inserido aqui -->
                </div>
            </div>

            <!-- Estatísticas Detalhadas -->
            <div class="grid lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm rounded-2xl shadow-2xl border border-white/20 dark:border-gray-700/50 p-6 card-hover">
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">
                        <i class="fas fa-trophy text-yellow-500 dark:text-yellow-400 mr-2"></i>
                        Serviços Mais Vendidos
                    </h4>
                    <div id="servicos-populares" class="space-y-2">
                        <!-- Lista será inserida aqui -->
                    </div>
                </div>

                <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm rounded-2xl shadow-2xl border border-white/20 dark:border-gray-700/50 p-6 card-hover">
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">
                        <i class="fas fa-clock text-blue-500 dark:text-blue-400 mr-2"></i>
                        Tempo Médio de Conclusão
                    </h4>
                    <div class="text-center">
                        <div id="tempo-medio-conclusao" class="text-3xl font-bold text-blue-600 dark:text-blue-400">0</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">dias em média</div>
                    </div>
                </div>

                <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm rounded-2xl shadow-2xl border border-white/20 dark:border-gray-700/50 p-6 card-hover">
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">
                        <i class="fas fa-percentage text-green-500 dark:text-green-400 mr-2"></i>
                        Taxa de Pagamento
                    </h4>
                    <div class="text-center">
                        <div id="taxa-pagamento" class="text-3xl font-bold text-green-600 dark:text-green-400">0%</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">dos valores recebidos</div>
                    </div>
                </div>
            </div>

            <!-- Controle de Pagamentos -->
            <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm rounded-2xl shadow-2xl border border-white/20 dark:border-gray-700/50 p-6 card-hover">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">
                    <i class="fas fa-credit-card text-purple-600 dark:text-purple-400 mr-2"></i>
                    Controle de Pagamentos
                </h2>
                
                <div id="lista-pagamentos" class="space-y-3">
                    <!-- Pagamentos serão inseridos aqui -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dados em memória
        let clientes = [];
        let servicos = [];
        let tiposServico = [];
        let proximoIdCliente = 1;
        let proximoIdServico = 1;
        let servicosTemporarios = []; // Lista de serviços sendo adicionados no formulário

        // Função para alternar modo escuro
        function toggleDarkMode() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('theme-icon');
            
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                themeIcon.className = 'fas fa-moon text-lg';
                localStorage.setItem('darkMode', 'false');
            } else {
                html.classList.add('dark');
                themeIcon.className = 'fas fa-sun text-lg';
                localStorage.setItem('darkMode', 'true');
            }
        }

        // Carregar preferência de tema
        function loadThemePreference() {
            const darkMode = localStorage.getItem('darkMode');
            const themeIcon = document.getElementById('theme-icon');
            
            if (darkMode === 'true') {
                document.documentElement.classList.add('dark');
                if (themeIcon) themeIcon.className = 'fas fa-sun text-lg';
            } else {
                document.documentElement.classList.remove('dark');
                if (themeIcon) themeIcon.className = 'fas fa-moon text-lg';
            }
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Carregar tema primeiro
            loadThemePreference();
            // Event listeners
            document.getElementById('cliente-form').addEventListener('submit', cadastrarCliente);
            document.getElementById('nota-fiscal').addEventListener('change', toggleNotaFiscal);
            document.getElementById('cep').addEventListener('blur', buscarCEP);
            document.getElementById('busca-cliente-geral').addEventListener('input', filtrarClientesGeral);
            document.getElementById('busca-cliente-form').addEventListener('input', buscarClienteExistente);
            document.getElementById('filtro-status').addEventListener('change', filtrarServicos);
            document.getElementById('valor-pago').addEventListener('input', calcularValorRestante);
            document.getElementById('data-inicio').addEventListener('change', calcularDataEntrega);
            document.getElementById('prazo-dias').addEventListener('change', function() {
                togglePrazoPersonalizado();
                calcularDataEntrega();
            });
            document.getElementById('prazo-personalizado-input').addEventListener('input', calcularDataEntrega);

            // Máscaras
            aplicarMascaras();
            
            // Carregar dados salvos PRIMEIRO
            carregarDados();
            
            // Inicializar tipos de serviço SEMPRE (mesmo se já existirem dados)
            inicializarTiposServico();
            
            // Atualizar tipos de serviço IMEDIATAMENTE
            atualizarTiposServico();
            atualizarTiposServicoNovo();
            
            // Atualizar displays
            atualizarSelectClientes();
            atualizarListaServicos();
            atualizarFinanceiro();
            atualizarResumoRapido();
        });

        function showTab(tabName) {
            // Esconder todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remover classe ativa de todos os botões
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('text-white', 'bg-gradient-to-r', 'from-blue-600', 'to-purple-600');
                btn.classList.add('text-gray-600', 'dark:text-gray-300');
                btn.style.background = '';
            });
            
            // Mostrar aba selecionada
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Ativar botão selecionado
            const activeBtn = document.getElementById('tab-' + tabName);
            activeBtn.classList.remove('text-gray-600', 'dark:text-gray-300');
            activeBtn.classList.add('text-white', 'bg-gradient-to-r', 'from-blue-600', 'to-purple-600');
            
            // Atualizar conteúdo específico da aba
            if (tabName === 'clientes') {
                atualizarListaClientesGeral();
                voltarListaClientes();
            } else if (tabName === 'novo-servico') {
                atualizarResumoRapido();
            }
        }

        function toggleNotaFiscal() {
            const checkbox = document.getElementById('nota-fiscal');
            const campos = document.getElementById('campos-nf');
            
            if (checkbox.checked) {
                campos.classList.remove('hidden');
            } else {
                campos.classList.add('hidden');
            }
        }

        function calcularValorRestante() {
            const valorTotal = calcularValorTotalServicos();
            const valorPago = parseFloat(document.getElementById('valor-pago').value) || 0;
            const valorRestante = valorTotal - valorPago;
            
            document.getElementById('valor-restante').value = `R$ ${valorRestante.toFixed(2).replace('.', ',')}`;
        }

        function calcularValorTotalServicos() {
            return servicosTemporarios.reduce((total, servico) => total + servico.valor, 0);
        }

        function atualizarValorTotalServicos() {
            const total = calcularValorTotalServicos();
            document.getElementById('valor-total-servicos').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
            calcularValorRestante();
            calcularParcelas();
        }

        function atualizarTiposServicoNovo() {
            const select = document.getElementById('novo-tipo-servico');
            
            if (!select) {
                console.error('Elemento novo-tipo-servico não encontrado');
                return;
            }
            
            // Garantir que tiposServico seja um array válido
            if (!Array.isArray(tiposServico) || tiposServico.length === 0) {
                inicializarTiposServico();
            }
            
            select.innerHTML = '<option value="">Selecione um serviço</option>' +
                tiposServico.map(tipo => `
                    <option value="${tipo}">${tipo}</option>
                `).join('');
            
            // Adicionar event listener para seleção automática
            select.addEventListener('change', function() {
                if (this.value) {
                    // Focar no campo de valor
                    document.getElementById('novo-valor-servico').focus();
                }
            });
        }

        function adicionarServicoLista() {
            const tipoServico = document.getElementById('novo-tipo-servico').value;
            const valorServico = parseFloat(document.getElementById('novo-valor-servico').value);
            
            if (!tipoServico) {
                alert('Selecione um tipo de serviço!');
                document.getElementById('novo-tipo-servico').focus();
                return;
            }
            
            if (!valorServico || valorServico <= 0) {
                alert('Digite um valor válido para o serviço!');
                document.getElementById('novo-valor-servico').focus();
                return;
            }
            
            // Verificar se o serviço já foi adicionado
            const servicoExistente = servicosTemporarios.find(s => s.tipo === tipoServico);
            if (servicoExistente) {
                const confirmar = confirm(`O serviço "${tipoServico}" já foi adicionado com valor R$ ${servicoExistente.valor.toFixed(2).replace('.', ',')}.\n\nDeseja adicionar novamente com valor R$ ${valorServico.toFixed(2).replace('.', ',')}?`);
                if (!confirmar) {
                    return;
                }
            }
            
            // Adicionar à lista temporária
            servicosTemporarios.push({
                id: Date.now(), // ID temporário
                tipo: tipoServico,
                valor: valorServico
            });
            
            // Limpar campos
            document.getElementById('novo-tipo-servico').value = '';
            document.getElementById('novo-valor-servico').value = '';
            
            // Focar novamente no select para facilitar adição de mais serviços
            document.getElementById('novo-tipo-servico').focus();
            
            // Atualizar display
            atualizarListaServicosAdicionados();
            atualizarValorTotalServicos();
            
            // Feedback visual
            const botaoAdicionar = event.target;
            const textoOriginal = botaoAdicionar.innerHTML;
            botaoAdicionar.innerHTML = '<i class="fas fa-check mr-1"></i>Adicionado!';
            botaoAdicionar.classList.add('bg-green-600');
            
            setTimeout(() => {
                botaoAdicionar.innerHTML = textoOriginal;
                botaoAdicionar.classList.remove('bg-green-600');
            }, 1000);
        }

        function atualizarListaServicosAdicionados() {
            const lista = document.getElementById('lista-servicos-adicionados');
            
            if (servicosTemporarios.length === 0) {
                lista.innerHTML = '<p class="text-gray-500 text-sm italic">Nenhum serviço adicionado ainda. Selecione um tipo de serviço acima para começar.</p>';
                return;
            }
            
            lista.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h4 class="font-medium text-green-800 mb-3">
                        <i class="fas fa-check-circle mr-2"></i>Serviços Adicionados (${servicosTemporarios.length})
                    </h4>
                    <div class="space-y-2">
                        ${servicosTemporarios.map((servico, index) => `
                            <div class="flex justify-between items-center bg-white p-3 rounded border hover:bg-gray-50 transition-colors">
                                <div class="flex items-center">
                                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mr-3">${index + 1}</span>
                                    <span class="font-medium text-gray-800">${servico.tipo}</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="font-semibold text-green-600">R$ ${servico.valor.toFixed(2).replace('.', ',')}</span>
                                    <button onclick="removerServicoLista(${servico.id})" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded transition-colors" title="Remover serviço">
                                        <i class="fas fa-trash text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-3 pt-3 border-t border-green-200">
                        <p class="text-sm text-green-700">
                            <i class="fas fa-info-circle mr-1"></i>
                            Você pode adicionar mais serviços selecionando outro tipo acima.
                        </p>
                    </div>
                </div>
            `;
        }

        function removerServicoLista(servicoId) {
            servicosTemporarios = servicosTemporarios.filter(s => s.id !== servicoId);
            atualizarListaServicosAdicionados();
            atualizarValorTotalServicos();
        }

        function toggleParcelamento() {
            const formaPagamento = document.querySelector('input[name="forma-pagamento"]:checked').value;
            const pagamentoAvista = document.getElementById('pagamento-avista');
            const pagamentoParcelado = document.getElementById('pagamento-parcelado');
            
            if (formaPagamento === 'avista') {
                pagamentoAvista.classList.remove('hidden');
                pagamentoParcelado.classList.add('hidden');
            } else {
                pagamentoAvista.classList.add('hidden');
                pagamentoParcelado.classList.remove('hidden');
                calcularParcelas();
            }
        }

        function calcularParcelas() {
            const valorTotal = calcularValorTotalServicos();
            const numeroParcelas = parseInt(document.getElementById('numero-parcelas').value);
            const valorEntrada = parseFloat(document.getElementById('valor-entrada').value) || 0;
            const dataPrimeiraParcela = document.getElementById('data-primeira-parcela').value;
            
            if (valorTotal === 0) return;
            
            const valorParcelar = valorTotal - valorEntrada;
            const valorParcela = valorParcelar / numeroParcelas;
            
            document.getElementById('valor-parcela').value = `R$ ${valorParcela.toFixed(2).replace('.', ',')}`;
            
            if (dataPrimeiraParcela) {
                gerarCronogramaParcelas(numeroParcelas, valorParcela, valorEntrada, dataPrimeiraParcela);
            }
        }

        function gerarCronogramaParcelas(numeroParcelas, valorParcela, valorEntrada, dataPrimeira) {
            const listaParcelas = document.getElementById('lista-parcelas');
            let html = '';
            
            // Entrada (se houver)
            if (valorEntrada > 0) {
                html += `
                    <div class="flex justify-between items-center p-2 bg-blue-100 rounded">
                        <span class="font-medium">Entrada</span>
                        <span class="font-semibold text-blue-600">R$ ${valorEntrada.toFixed(2).replace('.', ',')}</span>
                    </div>
                `;
            }
            
            // Parcelas
            const dataBase = new Date(dataPrimeira);
            for (let i = 1; i <= numeroParcelas; i++) {
                const dataParcela = new Date(dataBase);
                dataParcela.setMonth(dataParcela.getMonth() + (i - 1));
                
                html += `
                    <div class="flex justify-between items-center p-2 bg-white border rounded">
                        <span>${i}ª Parcela - ${dataParcela.toLocaleDateString('pt-BR')}</span>
                        <span class="font-semibold">R$ ${valorParcela.toFixed(2).replace('.', ',')}</span>
                    </div>
                `;
            }
            
            listaParcelas.innerHTML = html;
        }

        function togglePrazoPersonalizado() {
            const select = document.getElementById('prazo-dias');
            const campoPersonalizado = document.getElementById('prazo-personalizado');
            
            if (select.value === 'personalizado') {
                campoPersonalizado.classList.remove('hidden');
                document.getElementById('prazo-personalizado-input').required = true;
            } else {
                campoPersonalizado.classList.add('hidden');
                document.getElementById('prazo-personalizado-input').required = false;
                document.getElementById('prazo-personalizado-input').value = '';
            }
        }

        function calcularDataEntrega() {
            const dataInicio = document.getElementById('data-inicio').value;
            let prazoDias;
            
            if (document.getElementById('prazo-dias').value === 'personalizado') {
                prazoDias = parseInt(document.getElementById('prazo-personalizado-input').value);
            } else {
                prazoDias = parseInt(document.getElementById('prazo-dias').value);
            }
            
            if (dataInicio && prazoDias) {
                const dataInicioObj = new Date(dataInicio);
                const dataEntrega = new Date(dataInicioObj);
                dataEntrega.setDate(dataEntrega.getDate() + prazoDias);
                
                const dataFormatada = dataEntrega.toLocaleDateString('pt-BR');
                document.getElementById('data-entrega-calculada').value = dataFormatada;
            } else {
                document.getElementById('data-entrega-calculada').value = '';
            }
        }

        async function buscarCEP() {
            const cep = document.getElementById('cep').value.replace(/\D/g, '');
            
            if (cep.length === 8) {
                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await response.json();
                    
                    if (!data.erro) {
                        document.getElementById('logradouro').value = data.logradouro;
                        document.getElementById('bairro').value = data.bairro;
                        document.getElementById('cidade').value = data.localidade + ' - ' + data.uf;
                    } else {
                        alert('CEP não encontrado!');
                    }
                } catch (error) {
                    console.log('Erro ao buscar CEP:', error);
                    // Em caso de erro na API, permite continuar sem busca automática
                }
            }
        }

        function aplicarMascaras() {
            // Máscara para telefone
            document.getElementById('telefone').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                value = value.replace(/(\d{2})(\d)/, '($1) $2');
                value = value.replace(/(\d{5})(\d)/, '$1-$2');
                e.target.value = value;
            });

            // Máscara para CEP
            document.getElementById('cep').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                value = value.replace(/(\d{5})(\d)/, '$1-$2');
                e.target.value = value;
            });

            // Máscara para CPF
            document.getElementById('cpf').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                e.target.value = value;
            });
        }

        function cadastrarCliente(e) {
            e.preventDefault();
            
            // Verificar se há serviços adicionados
            if (servicosTemporarios.length === 0) {
                alert('Adicione pelo menos um serviço antes de finalizar o pedido!');
                return;
            }
            
            const valorTotal = calcularValorTotalServicos();
            const formaPagamento = document.querySelector('input[name="forma-pagamento"]:checked').value;
            let valorPago = 0;
            let parcelas = [];
            
            // Calcular valor pago baseado na forma de pagamento
            if (formaPagamento === 'avista') {
                valorPago = parseFloat(document.getElementById('valor-pago').value) || 0;
            } else {
                // Parcelado - apenas a entrada é considerada como paga
                valorPago = parseFloat(document.getElementById('valor-entrada').value) || 0;
                
                // Gerar informações das parcelas
                const numeroParcelas = parseInt(document.getElementById('numero-parcelas').value);
                const valorParcelar = valorTotal - valorPago;
                const valorParcela = valorParcelar / numeroParcelas;
                const dataPrimeiraParcela = document.getElementById('data-primeira-parcela').value;
                
                if (dataPrimeiraParcela) {
                    const dataBase = new Date(dataPrimeiraParcela);
                    for (let i = 1; i <= numeroParcelas; i++) {
                        const dataParcela = new Date(dataBase);
                        dataParcela.setMonth(dataParcela.getMonth() + (i - 1));
                        
                        parcelas.push({
                            numero: i,
                            valor: valorParcela,
                            dataVencimento: dataParcela.toISOString().split('T')[0],
                            pago: false
                        });
                    }
                }
            }
            
            // Verificar se é um cliente existente ou novo
            let clienteId = document.getElementById('cliente-form').dataset.clienteId;
            let cliente;
            
            if (clienteId) {
                // Cliente existente - usar ID existente
                clienteId = parseInt(clienteId);
                cliente = clientes.find(c => c.id === clienteId);
            } else {
                // Novo cliente - criar novo
                cliente = {
                    id: proximoIdCliente++,
                    nome: document.getElementById('nome').value,
                    telefone: document.getElementById('telefone').value,
                    quadra: document.getElementById('quadra').value,
                    lote: document.getElementById('lote').value,
                    falecido: document.getElementById('falecido').value,
                    notaFiscal: document.getElementById('nota-fiscal').checked,
                    endereco: document.getElementById('nota-fiscal').checked ? {
                        cep: document.getElementById('cep').value,
                        logradouro: document.getElementById('logradouro').value,
                        numero: document.getElementById('numero').value,
                        bairro: document.getElementById('bairro').value,
                        cidade: document.getElementById('cidade').value,
                        cpf: document.getElementById('cpf').value,
                        rg: document.getElementById('rg').value
                    } : null
                };
                clientes.push(cliente);
                clienteId = cliente.id;
            }
            
            const dataInicio = new Date(document.getElementById('data-inicio').value);
            let prazoDias;
            
            if (document.getElementById('prazo-dias').value === 'personalizado') {
                prazoDias = parseInt(document.getElementById('prazo-personalizado-input').value);
            } else {
                prazoDias = parseInt(document.getElementById('prazo-dias').value);
            }
            
            const dataEntrega = new Date(dataInicio);
            dataEntrega.setDate(dataEntrega.getDate() + prazoDias);

            // Criar um serviço único com múltiplos itens
            const descricaoServicos = servicosTemporarios.map(s => s.tipo).join(', ');
            const detalhesServicos = servicosTemporarios.map(s => ({
                tipo: s.tipo,
                valor: s.valor
            }));

            const servico = {
                id: proximoIdServico++,
                clienteId: clienteId,
                descricao: descricaoServicos,
                detalhesServicos: detalhesServicos, // Array com todos os serviços
                dataInicio: document.getElementById('data-inicio').value,
                prazoDias: prazoDias,
                prazoEntrega: dataEntrega.toISOString().split('T')[0],
                valorTotal: valorTotal,
                valorPago: valorPago,
                valorRestante: valorTotal - valorPago,
                status: document.getElementById('status-servico').value,
                observacoesPagamento: document.getElementById('obs-pagamento').value,
                formaPagamento: formaPagamento,
                parcelas: parcelas, // Array com informações das parcelas
                pago: valorPago >= valorTotal
            };
            
            servicos.push(servico);
            salvarDados();
            
            // Limpar formulário
            limparFormulario();
            
            // Atualizar listas
            atualizarSelectClientes();
            atualizarListaServicos();
            atualizarFinanceiro();
            atualizarResumoRapido();
            
            alert(`Pedido cadastrado com sucesso!\n\nServiços: ${descricaoServicos}\nValor Total: R$ ${valorTotal.toFixed(2).replace('.', ',')}\nForma de Pagamento: ${formaPagamento === 'avista' ? 'À Vista' : 'Parcelado'}`);
        }



        function atualizarListaClientesGeral() {
            const lista = document.getElementById('lista-clientes-geral');
            const busca = document.getElementById('busca-cliente-geral').value.toLowerCase();
            
            const clientesFiltrados = clientes.filter(cliente => 
                cliente.nome.toLowerCase().includes(busca) ||
                cliente.falecido.toLowerCase().includes(busca) ||
                cliente.telefone.includes(busca)
            );
            
            if (clientesFiltrados.length === 0) {
                lista.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-users text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">
                            ${clientes.length === 0 ? 'Nenhum cliente cadastrado' : 'Nenhum cliente encontrado'}
                        </h3>
                        <p class="text-gray-500">
                            ${clientes.length === 0 ? 'Cadastre o primeiro cliente na aba "Novo Serviço"' : 'Tente ajustar os termos da busca'}
                        </p>
                    </div>
                `;
                return;
            }
            
            lista.innerHTML = clientesFiltrados.map(cliente => {
                const servicosCliente = servicos.filter(s => s.clienteId === cliente.id);
                const totalServicos = servicosCliente.length;
                const servicosAtivos = servicosCliente.filter(s => s.status !== 'concluido').length;
                const valorTotal = servicosCliente.reduce((sum, s) => sum + s.valorTotal, 0);
                const valorPendente = servicosCliente.reduce((sum, s) => sum + s.valorRestante, 0);
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition-colors" onclick="mostrarDetalhesCliente(${cliente.id})">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-800 mb-1">${cliente.nome}</h3>
                                <p class="text-sm text-gray-600 mb-1">
                                    <i class="fas fa-user-circle mr-1"></i>Falecido: ${cliente.falecido}
                                </p>
                                <p class="text-sm text-gray-600 mb-2">
                                    <i class="fas fa-map-marker-alt mr-1"></i>Quadra: ${cliente.quadra} | Lote: ${cliente.lote}
                                </p>
                                <p class="text-sm text-gray-600">
                                    <i class="fas fa-phone mr-1"></i>${cliente.telefone}
                                </p>
                                ${cliente.notaFiscal ? '<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mt-2">Nota Fiscal</span>' : ''}
                            </div>
                            
                            <div class="text-right">
                                <div class="grid grid-cols-2 gap-3 mb-3">
                                    <div class="bg-blue-50 rounded-lg p-2 text-center">
                                        <div class="text-lg font-bold text-blue-600">${totalServicos}</div>
                                        <div class="text-xs text-blue-600">Serviços</div>
                                    </div>
                                    <div class="bg-yellow-50 rounded-lg p-2 text-center">
                                        <div class="text-lg font-bold text-yellow-600">${servicosAtivos}</div>
                                        <div class="text-xs text-yellow-600">Ativos</div>
                                    </div>
                                </div>
                                
                                <div class="text-right">
                                    <p class="text-sm font-semibold text-gray-700">Total: R$ ${valorTotal.toFixed(2).replace('.', ',')}</p>
                                    ${valorPendente > 0 ? `
                                        <p class="text-sm font-medium text-red-600">Pendente: R$ ${valorPendente.toFixed(2).replace('.', ',')}</p>
                                    ` : `
                                        <p class="text-sm font-medium text-green-600">Tudo Pago</p>
                                    `}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3 pt-3 border-t border-gray-200 flex justify-end">
                            <span class="text-xs text-gray-500">
                                <i class="fas fa-mouse-pointer mr-1"></i>Clique para ver detalhes e histórico
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function atualizarResumoRapido() {
            const totalClientes = clientes.length;
            const servicosAtivos = servicos.filter(s => s.status !== 'concluido').length;
            const pagamentosPendentes = servicos.filter(s => s.valorRestante > 0).length;
            
            document.getElementById('total-clientes-resumo').textContent = totalClientes;
            document.getElementById('servicos-ativos-resumo').textContent = servicosAtivos;
            document.getElementById('pagamentos-pendentes-resumo').textContent = pagamentosPendentes;
        }

        function atualizarSelectClientes() {
            const select = document.getElementById('cliente-servico');
            select.innerHTML = '<option value="">Selecione um cliente</option>' +
                clientes.map(cliente => `
                    <option value="${cliente.id}">${cliente.nome} - ${cliente.falecido}</option>
                `).join('');
        }

        function atualizarListaServicos() {
            const lista = document.getElementById('lista-servicos');
            const filtroStatus = document.getElementById('filtro-status').value;
            
            const servicosFiltrados = servicos.filter(servico => 
                !filtroStatus || servico.status === filtroStatus
            ).sort((a, b) => {
                // Ordenar por data de entrega (prazo mais curto primeiro)
                const dataA = new Date(a.prazoEntrega);
                const dataB = new Date(b.prazoEntrega);
                return dataA - dataB;
            });
            
            lista.innerHTML = servicosFiltrados.map(servico => {
                const cliente = clientes.find(c => c.id === servico.clienteId);
                const hoje = new Date();
                const prazo = new Date(servico.prazoEntrega);
                const diasRestantes = Math.ceil((prazo - hoje) / (1000 * 60 * 60 * 24));
                
                let corPrazo = 'text-green-600';
                if (diasRestantes < 0) corPrazo = 'text-red-600';
                else if (diasRestantes <= 3) corPrazo = 'text-yellow-600';
                
                let corStatus = 'bg-yellow-100 text-yellow-800';
                if (servico.status === 'concluido') corStatus = 'bg-green-100 text-green-800';
                else if (servico.status === 'em-andamento') corStatus = 'bg-blue-100 text-blue-800';
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold text-gray-800">${cliente ? cliente.nome : 'Cliente não encontrado'}</h3>
                            <span class="inline-block ${corStatus} text-xs px-2 py-1 rounded-full">${servico.status.replace('-', ' ').toUpperCase()}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">${servico.descricao}</p>
                        <div class="text-xs text-gray-500 mb-2">
                            Prazo: ${servico.prazoDias} dias | Entrega: ${new Date(servico.prazoEntrega).toLocaleDateString('pt-BR')}
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <div>
                                <span class="${corPrazo} font-medium text-sm">
                                    ${diasRestantes >= 0 ? `${diasRestantes} dias restantes` : `${Math.abs(diasRestantes)} dias em atraso`}
                                </span>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-semibold">Total: R$ ${servico.valorTotal.toFixed(2).replace('.', ',')}</p>
                                <p class="text-sm">Pago: R$ ${servico.valorPago.toFixed(2).replace('.', ',')}</p>
                                <p class="text-sm ${servico.valorRestante > 0 ? 'text-red-600' : 'text-green-600'} font-medium">
                                    ${servico.valorRestante > 0 ? 
                                        `Falta: R$ ${servico.valorRestante.toFixed(2).replace('.', ',')}` : 
                                        'Pago Completo'
                                    }
                                </p>
                            </div>
                        </div>
                        ${servico.observacoesPagamento ? `
                            <div class="bg-gray-50 p-2 rounded text-xs text-gray-600 mb-3">
                                <strong>Obs:</strong> ${servico.observacoesPagamento}
                            </div>
                        ` : ''}
                        <div class="flex flex-wrap gap-2">
                            <button onclick="alterarStatusServico(${servico.id})" class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600">
                                Alterar Status
                            </button>
                            <button onclick="editarServico(${servico.id})" class="bg-yellow-500 text-white px-3 py-1 rounded text-xs hover:bg-yellow-600">
                                Editar Serviço
                            </button>
                            ${servico.status === 'concluido' ? `
                                <a href="https://wa.me/55${cliente ? cliente.telefone.replace(/\D/g, '') : ''}?text=Olá%20${cliente ? encodeURIComponent(cliente.nome) : ''}!%20Seu%20serviço%20${encodeURIComponent(servico.descricao)}%20foi%20concluído.%20Segue%20foto%20do%20resultado:" 
                                   target="_blank" rel="noopener noreferrer" 
                                   class="bg-green-500 text-white px-3 py-1 rounded text-xs hover:bg-green-600 flex items-center">
                                    <i class="fab fa-whatsapp mr-1"></i>Enviar Foto
                                </a>
                            ` : ''}
                            ${servico.valorRestante > 0 ? `
                                <button onclick="adicionarPagamento(${servico.clienteId})" class="bg-green-500 text-white px-3 py-1 rounded text-xs hover:bg-green-600">
                                    Adicionar Pagamento
                                </button>
                            ` : `
                                <span class="bg-green-100 text-green-800 px-3 py-1 rounded text-xs">Pago Completo</span>
                            `}
                            <button onclick="cancelarServico(${servico.id})" class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600">
                                Cancelar Serviço
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function atualizarFinanceiro() {
            const totalRecebido = servicos.reduce((sum, s) => sum + s.valorPago, 0);
            const totalPendente = servicos.reduce((sum, s) => sum + s.valorRestante, 0);
            const totalGeral = totalRecebido + totalPendente;
            
            document.getElementById('total-recebido').textContent = `R$ ${totalRecebido.toFixed(2).replace('.', ',')}`;
            document.getElementById('total-pendente').textContent = `R$ ${totalPendente.toFixed(2).replace('.', ',')}`;
            document.getElementById('total-geral').textContent = `R$ ${totalGeral.toFixed(2).replace('.', ',')}`;
            
            // Atualizar análises comparativas
            atualizarAnalisesSemanal();
            atualizarAnalisesMensal();
            atualizarGraficoEvolucao();
            atualizarEstatisticasDetalhadas();
            
            // Lista de pagamentos
            const listaPagamentos = document.getElementById('lista-pagamentos');
            listaPagamentos.innerHTML = servicos.map(servico => {
                const cliente = clientes.find(c => c.id === servico.clienteId);
                return `
                    <div class="p-4 border border-gray-200 rounded-lg ${servico.valorRestante === 0 ? 'bg-green-50' : 'bg-yellow-50'}">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-semibold text-gray-800">${cliente ? cliente.nome : 'Cliente não encontrado'}</h4>
                                <p class="text-sm text-gray-600">${servico.descricao}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-lg">R$ ${servico.valorTotal.toFixed(2).replace('.', ',')}</p>
                                <span class="inline-block px-2 py-1 rounded-full text-xs ${servico.valorRestante === 0 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${servico.valorRestante === 0 ? 'Pago Completo' : 'Pendente'}
                                </span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">Pago: </span>
                                <span class="font-medium text-green-600">R$ ${servico.valorPago.toFixed(2).replace('.', ',')}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-gray-600">Restante: </span>
                                <span class="font-medium ${servico.valorRestante > 0 ? 'text-red-600' : 'text-green-600'}">
                                    R$ ${servico.valorRestante.toFixed(2).replace('.', ',')}
                                </span>
                            </div>
                        </div>
                        ${servico.valorRestante > 0 ? `
                            <div class="mt-3">
                                <button onclick="adicionarPagamento(${servico.clienteId})" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                    Adicionar Pagamento
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function atualizarAnalisesSemanal() {
            const hoje = new Date();
            const inicioSemanaAtual = new Date(hoje);
            inicioSemanaAtual.setDate(hoje.getDate() - hoje.getDay());
            inicioSemanaAtual.setHours(0, 0, 0, 0);
            
            const fimSemanaAtual = new Date(inicioSemanaAtual);
            fimSemanaAtual.setDate(inicioSemanaAtual.getDate() + 6);
            fimSemanaAtual.setHours(23, 59, 59, 999);
            
            const inicioSemanaAnterior = new Date(inicioSemanaAtual);
            inicioSemanaAnterior.setDate(inicioSemanaAtual.getDate() - 7);
            
            const fimSemanaAnterior = new Date(inicioSemanaAtual);
            fimSemanaAnterior.setDate(inicioSemanaAtual.getDate() - 1);
            
            // Serviços desta semana
            const servicosSemanaAtual = servicos.filter(s => {
                const dataServico = new Date(s.dataInicio);
                return dataServico >= inicioSemanaAtual && dataServico <= fimSemanaAtual;
            });
            
            // Serviços da semana anterior
            const servicosSemanaAnterior = servicos.filter(s => {
                const dataServico = new Date(s.dataInicio);
                return dataServico >= inicioSemanaAnterior && dataServico <= fimSemanaAnterior;
            });
            
            const receitaSemanaAtual = servicosSemanaAtual.reduce((sum, s) => sum + s.valorTotal, 0);
            const receitaSemanaAnterior = servicosSemanaAnterior.reduce((sum, s) => sum + s.valorTotal, 0);
            const variacaoSemanal = receitaSemanaAtual - receitaSemanaAnterior;
            const percentualSemanal = receitaSemanaAnterior > 0 ? (variacaoSemanal / receitaSemanaAnterior) * 100 : 0;
            
            document.getElementById('receita-semana-atual').textContent = `R$ ${receitaSemanaAtual.toFixed(2).replace('.', ',')}`;
            document.getElementById('servicos-semana-atual').textContent = servicosSemanaAtual.length;
            document.getElementById('receita-semana-anterior').textContent = `R$ ${receitaSemanaAnterior.toFixed(2).replace('.', ',')}`;
            document.getElementById('servicos-semana-anterior').textContent = servicosSemanaAnterior.length;
            
            const elementoVariacaoValor = document.getElementById('variacao-semanal-valor');
            const elementoVariacaoPercentual = document.getElementById('variacao-semanal-percentual');
            
            elementoVariacaoValor.textContent = `${variacaoSemanal >= 0 ? '+' : ''}R$ ${Math.abs(variacaoSemanal).toFixed(2).replace('.', ',')}`;
            elementoVariacaoPercentual.textContent = `${percentualSemanal >= 0 ? '+' : ''}${percentualSemanal.toFixed(1)}%`;
            
            // Cores baseadas na variação
            if (variacaoSemanal > 0) {
                elementoVariacaoValor.className = 'font-bold text-green-600';
                elementoVariacaoPercentual.className = 'text-sm text-green-600';
            } else if (variacaoSemanal < 0) {
                elementoVariacaoValor.className = 'font-bold text-red-600';
                elementoVariacaoPercentual.className = 'text-sm text-red-600';
            } else {
                elementoVariacaoValor.className = 'font-bold text-gray-600';
                elementoVariacaoPercentual.className = 'text-sm text-gray-600';
            }
        }

        function atualizarAnalisesMensal() {
            const hoje = new Date();
            const inicioMesAtual = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            const fimMesAtual = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
            
            const inicioMesAnterior = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
            const fimMesAnterior = new Date(hoje.getFullYear(), hoje.getMonth(), 0);
            
            // Serviços deste mês
            const servicosMesAtual = servicos.filter(s => {
                const dataServico = new Date(s.dataInicio);
                return dataServico >= inicioMesAtual && dataServico <= fimMesAtual;
            });
            
            // Serviços do mês anterior
            const servicosMesAnterior = servicos.filter(s => {
                const dataServico = new Date(s.dataInicio);
                return dataServico >= inicioMesAnterior && dataServico <= fimMesAnterior;
            });
            
            const receitaMesAtual = servicosMesAtual.reduce((sum, s) => sum + s.valorTotal, 0);
            const receitaMesAnterior = servicosMesAnterior.reduce((sum, s) => sum + s.valorTotal, 0);
            const variacaoMensal = receitaMesAtual - receitaMesAnterior;
            const percentualMensal = receitaMesAnterior > 0 ? (variacaoMensal / receitaMesAnterior) * 100 : 0;
            
            document.getElementById('receita-mes-atual').textContent = `R$ ${receitaMesAtual.toFixed(2).replace('.', ',')}`;
            document.getElementById('servicos-mes-atual').textContent = servicosMesAtual.length;
            document.getElementById('receita-mes-anterior').textContent = `R$ ${receitaMesAnterior.toFixed(2).replace('.', ',')}`;
            document.getElementById('servicos-mes-anterior').textContent = servicosMesAnterior.length;
            
            const elementoVariacaoValor = document.getElementById('variacao-mensal-valor');
            const elementoVariacaoPercentual = document.getElementById('variacao-mensal-percentual');
            
            elementoVariacaoValor.textContent = `${variacaoMensal >= 0 ? '+' : ''}R$ ${Math.abs(variacaoMensal).toFixed(2).replace('.', ',')}`;
            elementoVariacaoPercentual.textContent = `${percentualMensal >= 0 ? '+' : ''}${percentualMensal.toFixed(1)}%`;
            
            // Cores baseadas na variação
            if (variacaoMensal > 0) {
                elementoVariacaoValor.className = 'font-bold text-green-600';
                elementoVariacaoPercentual.className = 'text-sm text-green-600';
            } else if (variacaoMensal < 0) {
                elementoVariacaoValor.className = 'font-bold text-red-600';
                elementoVariacaoPercentual.className = 'text-sm text-red-600';
            } else {
                elementoVariacaoValor.className = 'font-bold text-gray-600';
                elementoVariacaoPercentual.className = 'text-sm text-gray-600';
            }
        }

        function atualizarGraficoEvolucao() {
            const hoje = new Date();
            const dadosMeses = [];
            
            // Gerar dados dos últimos 6 meses
            for (let i = 5; i >= 0; i--) {
                const mes = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                const proximoMes = new Date(hoje.getFullYear(), hoje.getMonth() - i + 1, 1);
                
                const servicosDoMes = servicos.filter(s => {
                    const dataServico = new Date(s.dataInicio);
                    return dataServico >= mes && dataServico < proximoMes;
                });
                
                const receitaDoMes = servicosDoMes.reduce((sum, s) => sum + s.valorTotal, 0);
                
                dadosMeses.push({
                    mes: mes.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' }),
                    receita: receitaDoMes,
                    servicos: servicosDoMes.length
                });
            }
            
            const maxReceita = Math.max(...dadosMeses.map(d => d.receita));
            
            const grafico = document.getElementById('grafico-evolucao');
            grafico.innerHTML = dadosMeses.map(dado => {
                const altura = maxReceita > 0 ? (dado.receita / maxReceita) * 100 : 0;
                return `
                    <div class="flex items-end justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">${dado.mes}</div>
                            <div class="text-sm text-gray-600">${dado.servicos} serviços</div>
                        </div>
                        <div class="flex items-end space-x-2">
                            <div class="bg-blue-500 rounded-t" style="width: 20px; height: ${Math.max(altura * 0.6, 4)}px;" title="Receita: R$ ${dado.receita.toFixed(2).replace('.', ',')}"></div>
                            <div class="text-right">
                                <div class="font-semibold text-blue-600">R$ ${dado.receita.toFixed(2).replace('.', ',')}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function atualizarEstatisticasDetalhadas() {
            // Serviços mais populares
            const contadorServicos = {};
            servicos.forEach(servico => {
                if (servico.detalhesServicos) {
                    servico.detalhesServicos.forEach(detalhe => {
                        contadorServicos[detalhe.tipo] = (contadorServicos[detalhe.tipo] || 0) + 1;
                    });
                } else {
                    contadorServicos[servico.descricao] = (contadorServicos[servico.descricao] || 0) + 1;
                }
            });
            
            const servicosOrdenados = Object.entries(contadorServicos)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            document.getElementById('servicos-populares').innerHTML = servicosOrdenados.length > 0 
                ? servicosOrdenados.map(([servico, quantidade], index) => `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <div class="flex items-center">
                            <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full mr-2">${index + 1}º</span>
                            <span class="text-sm font-medium text-gray-700">${servico}</span>
                        </div>
                        <span class="text-sm font-semibold text-gray-600">${quantidade}x</span>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">Nenhum serviço cadastrado ainda</p>';
            
            // Tempo médio de conclusão
            const servicosConcluidos = servicos.filter(s => s.status === 'concluido');
            const tempoMedio = servicosConcluidos.length > 0 
                ? servicosConcluidos.reduce((sum, s) => sum + s.prazoDias, 0) / servicosConcluidos.length 
                : 0;
            
            document.getElementById('tempo-medio-conclusao').textContent = tempoMedio.toFixed(1);
            
            // Taxa de pagamento
            const totalServicos = servicos.reduce((sum, s) => sum + s.valorTotal, 0);
            const totalPago = servicos.reduce((sum, s) => sum + s.valorPago, 0);
            const taxaPagamento = totalServicos > 0 ? (totalPago / totalServicos) * 100 : 0;
            
            document.getElementById('taxa-pagamento').textContent = `${taxaPagamento.toFixed(1)}%`;
        }

        function filtrarClientesGeral() {
            atualizarListaClientesGeral();
        }
        
        function mostrarDetalhesCliente(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            const servicosCliente = servicos.filter(s => s.clienteId === clienteId);
            
            if (!cliente) return;
            
            // Esconder lista e mostrar detalhes
            document.getElementById('lista-clientes-geral').classList.add('hidden');
            document.getElementById('detalhes-cliente').classList.remove('hidden');
            document.getElementById('btn-voltar-lista').classList.remove('hidden');
            
            // Calcular estatísticas
            const totalServicos = servicosCliente.length;
            const servicosAtivos = servicosCliente.filter(s => s.status !== 'concluido').length;
            const servicosConcluidos = servicosCliente.filter(s => s.status === 'concluido').length;
            const valorTotal = servicosCliente.reduce((sum, s) => sum + s.valorTotal, 0);
            const valorPago = servicosCliente.reduce((sum, s) => sum + s.valorPago, 0);
            const valorPendente = servicosCliente.reduce((sum, s) => sum + s.valorRestante, 0);
            
            document.getElementById('detalhes-cliente').innerHTML = `
                <div class="space-y-6">
                    <!-- Botão para voltar à visualização simplificada -->
                    <div class="flex justify-center">
                        <button onclick="voltarListaClientes()" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 px-4 py-2 rounded-full transition duration-200 flex items-center">
                            <i class="fas fa-chevron-up mr-2"></i>Voltar à Lista de Clientes
                        </button>
                    </div>
                    
                    <!-- Cabeçalho do Cliente -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h3 class="text-2xl font-bold text-gray-800 mb-2">${cliente.nome}</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-600">
                                    <div><i class="fas fa-user-circle mr-2 text-blue-600"></i><strong>Falecido:</strong> ${cliente.falecido}</div>
                                    <div><i class="fas fa-phone mr-2 text-blue-600"></i><strong>Telefone:</strong> ${cliente.telefone}</div>
                                    <div><i class="fas fa-map-marker-alt mr-2 text-blue-600"></i><strong>Localização:</strong> Quadra ${cliente.quadra}, Lote ${cliente.lote}</div>
                                    <div><i class="fas fa-calendar mr-2 text-blue-600"></i><strong>Cliente desde:</strong> ${servicosCliente.length > 0 ? new Date(Math.min(...servicosCliente.map(s => new Date(s.dataInicio)))).toLocaleDateString('pt-BR') : 'N/A'}</div>
                                </div>
                                ${cliente.notaFiscal ? `
                                    <div class="mt-3">
                                        <span class="inline-block bg-blue-100 text-blue-800 text-xs px-3 py-1 rounded-full">
                                            <i class="fas fa-file-invoice mr-1"></i>Solicita Nota Fiscal
                                        </span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="flex gap-2">
                                <a href="https://wa.me/55${cliente.telefone.replace(/\D/g, '')}" target="_blank" rel="noopener noreferrer" 
                                   class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200">
                                    <i class="fab fa-whatsapp mr-2"></i>WhatsApp
                                </a>
                                <button onclick="editarCliente(${cliente.id})" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200">
                                    <i class="fas fa-edit mr-2"></i>Editar
                                </button>
                                <button onclick="excluirCliente(${cliente.id})" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200">
                                    <i class="fas fa-trash mr-2"></i>Excluir
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estatísticas Rápidas -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600">${totalServicos}</div>
                            <div class="text-sm text-blue-600">Total de Serviços</div>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-yellow-600">${servicosAtivos}</div>
                            <div class="text-sm text-yellow-600">Serviços Ativos</div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-600">${servicosConcluidos}</div>
                            <div class="text-sm text-green-600">Concluídos</div>
                        </div>
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                            <div class="text-xl font-bold text-purple-600">R$ ${valorTotal.toFixed(2).replace('.', ',')}</div>
                            <div class="text-sm text-purple-600">Valor Total</div>
                        </div>
                    </div>
                    
                    <!-- Situação Financeira -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-credit-card text-green-600 mr-2"></i>Situação Financeira
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-xl font-bold text-green-600">R$ ${valorPago.toFixed(2).replace('.', ',')}</div>
                                <div class="text-sm text-gray-600">Valor Pago</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold ${valorPendente > 0 ? 'text-red-600' : 'text-green-600'}">R$ ${valorPendente.toFixed(2).replace('.', ',')}</div>
                                <div class="text-sm text-gray-600">Valor Pendente</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold text-blue-600">${valorTotal > 0 ? ((valorPago / valorTotal) * 100).toFixed(1) : 0}%</div>
                                <div class="text-sm text-gray-600">Percentual Pago</div>
                            </div>
                        </div>
                        ${valorPendente > 0 ? `
                            <div class="mt-4 text-center">
                                <button onclick="adicionarPagamento(${cliente.id})" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition duration-200">
                                    <i class="fas fa-money-bill mr-2"></i>Receber Pagamento
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Histórico de Serviços -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-semibold text-gray-800">
                                <i class="fas fa-history text-purple-600 mr-2"></i>Histórico de Serviços
                            </h4>
                            <span class="text-sm text-gray-500">${totalServicos} serviço(s) encontrado(s)</span>
                        </div>
                        
                        ${servicosCliente.length === 0 ? `
                            <div class="text-center py-8">
                                <i class="fas fa-clipboard-list text-4xl text-gray-300 mb-3"></i>
                                <p class="text-gray-500">Nenhum serviço cadastrado para este cliente</p>
                            </div>
                        ` : `
                            <div class="space-y-3 max-h-96 overflow-y-auto">
                                ${servicosCliente.sort((a, b) => new Date(b.dataInicio) - new Date(a.dataInicio)).map(servico => {
                                    const hoje = new Date();
                                    const prazo = new Date(servico.prazoEntrega);
                                    const diasRestantes = Math.ceil((prazo - hoje) / (1000 * 60 * 60 * 24));
                                    
                                    let corStatus = 'bg-yellow-100 text-yellow-800';
                                    if (servico.status === 'concluido') corStatus = 'bg-green-100 text-green-800';
                                    else if (servico.status === 'em-andamento') corStatus = 'bg-blue-100 text-blue-800';
                                    
                                    let corPrazo = 'text-green-600';
                                    if (servico.status !== 'concluido') {
                                        if (diasRestantes < 0) corPrazo = 'text-red-600';
                                        else if (diasRestantes <= 3) corPrazo = 'text-yellow-600';
                                    }
                                    
                                    return `
                                        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                            <div class="flex justify-between items-start mb-2">
                                                <div class="flex-1">
                                                    <h5 class="font-medium text-gray-800">${servico.descricao}</h5>
                                                    ${servico.detalhesServicos ? `
                                                        <div class="text-xs text-gray-500 mt-1">
                                                            ${servico.detalhesServicos.map(detalhe => 
                                                                `${detalhe.tipo}: R$ ${detalhe.valor.toFixed(2).replace('.', ',')}`
                                                            ).join(' • ')}
                                                        </div>
                                                    ` : ''}
                                                    <div class="text-sm text-gray-600 mt-1">
                                                        <i class="fas fa-calendar mr-1"></i>Contratado: ${new Date(servico.dataInicio).toLocaleDateString('pt-BR')}
                                                        <span class="mx-2">•</span>
                                                        <i class="fas fa-clock mr-1"></i>Prazo: ${new Date(servico.prazoEntrega).toLocaleDateString('pt-BR')}
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    <span class="inline-block ${corStatus} text-xs px-2 py-1 rounded-full mb-1">${servico.status.replace('-', ' ').toUpperCase()}</span>
                                                    <div class="text-sm font-semibold">R$ ${servico.valorTotal.toFixed(2).replace('.', ',')}</div>
                                                </div>
                                            </div>
                                            
                                            <div class="flex justify-between items-center text-sm">
                                                <div>
                                                    ${servico.status !== 'concluido' ? `
                                                        <span class="${corPrazo} font-medium">
                                                            ${diasRestantes >= 0 ? `${diasRestantes} dias restantes` : `${Math.abs(diasRestantes)} dias em atraso`}
                                                        </span>
                                                    ` : `
                                                        <span class="text-green-600 font-medium">
                                                            <i class="fas fa-check-circle mr-1"></i>Concluído
                                                        </span>
                                                    `}
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-xs text-gray-500">
                                                        Pago: R$ ${servico.valorPago.toFixed(2).replace('.', ',')} 
                                                        ${servico.valorRestante > 0 ? `| Falta: R$ ${servico.valorRestante.toFixed(2).replace('.', ',')}` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            ${servico.observacoesPagamento ? `
                                                <div class="mt-2 p-2 bg-gray-50 rounded text-xs text-gray-600">
                                                    <strong>Obs:</strong> ${servico.observacoesPagamento}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }
        
        function voltarListaClientes() {
            document.getElementById('lista-clientes-geral').classList.remove('hidden');
            document.getElementById('detalhes-cliente').classList.add('hidden');
            document.getElementById('btn-voltar-lista').classList.add('hidden');
        }

        function filtrarServicos() {
            atualizarListaServicos();
        }

        function alterarStatusServico(id) {
            const servico = servicos.find(s => s.id === id);
            const cliente = clientes.find(c => c.id === servico.clienteId);
            
            if (!servico) return;
            
            // Criar modal com opções de status clicáveis
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 border border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white">
                            <i class="fas fa-edit text-blue-600 dark:text-blue-400 mr-2"></i>
                            Alterar Status
                        </h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg border border-blue-200 dark:border-blue-700">
                        <p class="font-semibold text-gray-800 dark:text-white text-lg">${cliente ? cliente.nome : 'Cliente não encontrado'}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">${servico.descricao}</p>
                        <div class="mt-2 flex items-center">
                            <span class="text-xs text-gray-500 dark:text-gray-400">Status atual:</span>
                            <span class="ml-2 px-2 py-1 rounded-full text-xs font-medium ${
                                servico.status === 'pendente' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300' :
                                servico.status === 'em-andamento' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300' :
                                'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300'
                            }">${servico.status.replace('-', ' ').toUpperCase()}</span>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-4">
                            <i class="fas fa-mouse-pointer mr-2 text-blue-500"></i>
                            Clique no status desejado:
                        </p>
                        
                        <button onclick="confirmarAlteracaoStatus(${id}, 'pendente')" 
                                class="w-full p-4 text-left rounded-xl border-2 transition-all duration-300 transform hover:scale-[1.02] ${
                                    servico.status === 'pendente' ? 
                                    'border-yellow-400 bg-yellow-50 dark:bg-yellow-900/30 shadow-lg' : 
                                    'border-gray-200 dark:border-gray-600 hover:border-yellow-300 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 hover:shadow-md'
                                }">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-4 h-4 rounded-full bg-yellow-500 mr-4 shadow-sm"></div>
                                    <div>
                                        <div class="font-semibold text-gray-800 dark:text-white text-lg">🟡 Pendente</div>
                                        <div class="text-sm text-gray-600 dark:text-gray-300">Serviço ainda não foi iniciado</div>
                                    </div>
                                </div>
                                ${servico.status === 'pendente' ? '<i class="fas fa-check-circle text-yellow-600 text-xl"></i>' : '<i class="fas fa-chevron-right text-gray-400"></i>'}
                            </div>
                        </button>
                        
                        <button onclick="confirmarAlteracaoStatus(${id}, 'em-andamento')" 
                                class="w-full p-4 text-left rounded-xl border-2 transition-all duration-300 transform hover:scale-[1.02] ${
                                    servico.status === 'em-andamento' ? 
                                    'border-blue-400 bg-blue-50 dark:bg-blue-900/30 shadow-lg' : 
                                    'border-gray-200 dark:border-gray-600 hover:border-blue-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:shadow-md'
                                }">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-4 h-4 rounded-full bg-blue-500 mr-4 shadow-sm"></div>
                                    <div>
                                        <div class="font-semibold text-gray-800 dark:text-white text-lg">🔵 Em Andamento</div>
                                        <div class="text-sm text-gray-600 dark:text-gray-300">Serviço está sendo executado</div>
                                    </div>
                                </div>
                                ${servico.status === 'em-andamento' ? '<i class="fas fa-check-circle text-blue-600 text-xl"></i>' : '<i class="fas fa-chevron-right text-gray-400"></i>'}
                            </div>
                        </button>
                        
                        <button onclick="confirmarAlteracaoStatus(${id}, 'concluido')" 
                                class="w-full p-4 text-left rounded-xl border-2 transition-all duration-300 transform hover:scale-[1.02] ${
                                    servico.status === 'concluido' ? 
                                    'border-green-400 bg-green-50 dark:bg-green-900/30 shadow-lg' : 
                                    'border-gray-200 dark:border-gray-600 hover:border-green-300 hover:bg-green-50 dark:hover:bg-green-900/20 hover:shadow-md'
                                }">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-4 h-4 rounded-full bg-green-500 mr-4 shadow-sm"></div>
                                    <div>
                                        <div class="font-semibold text-gray-800 dark:text-white text-lg">🟢 Concluído</div>
                                        <div class="text-sm text-gray-600 dark:text-gray-300">Serviço foi finalizado</div>
                                    </div>
                                </div>
                                ${servico.status === 'concluido' ? '<i class="fas fa-check-circle text-green-600 text-xl"></i>' : '<i class="fas fa-chevron-right text-gray-400"></i>'}
                            </div>
                        </button>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-600">
                        <button onclick="this.closest('.fixed').remove()" 
                                class="w-full bg-gray-500 dark:bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-600 dark:hover:bg-gray-700 transition duration-200 font-medium">
                            <i class="fas fa-times mr-2"></i>Cancelar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function confirmarAlteracaoStatus(servicoId, novoStatus) {
            const servico = servicos.find(s => s.id === servicoId);
            const cliente = clientes.find(c => c.id === servico.clienteId);
            
            if (!servico) return;
            
            const statusAnterior = servico.status;
            servico.status = novoStatus;
            
            salvarDados();
            atualizarListaServicos();
            atualizarFinanceiro();
            atualizarResumoRapido();
            
            // Fechar modal
            document.querySelector('.fixed').remove();
            
            // Mostrar confirmação
            const statusTexto = {
                'pendente': 'Pendente',
                'em-andamento': 'Em Andamento', 
                'concluido': 'Concluído'
            };
            
            alert(`✅ Status alterado com sucesso!\n\nCliente: ${cliente ? cliente.nome : 'N/A'}\nServiço: ${servico.descricao}\n\nDe: ${statusTexto[statusAnterior]}\nPara: ${statusTexto[novoStatus]}`);
        }

        function adicionarPagamento(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            const servicosCliente = servicos.filter(s => s.clienteId === clienteId && s.valorRestante > 0);
            
            if (servicosCliente.length === 0) {
                alert('Este cliente não possui pagamentos pendentes.');
                return;
            }
            
            const servico = servicosCliente[0]; // Pega o primeiro serviço pendente
            const valorRestante = servico.valorRestante;
            
            const valorPagamento = prompt(`Cliente: ${cliente.nome}\nValor restante: R$ ${valorRestante.toFixed(2).replace('.', ',')}\n\nDigite o valor do pagamento:`);
            
            if (valorPagamento && !isNaN(valorPagamento)) {
                const valor = parseFloat(valorPagamento);
                
                if (valor > 0 && valor <= valorRestante) {
                    servico.valorPago += valor;
                    servico.valorRestante = servico.valorTotal - servico.valorPago;
                    
                    if (servico.valorRestante <= 0) {
                        servico.valorRestante = 0;
                        servico.pago = true;
                    }
                    
                    salvarDados();
                    atualizarListaClientes();
                    atualizarListaServicos();
                    atualizarFinanceiro();
                    
                    alert(`Pagamento de R$ ${valor.toFixed(2).replace('.', ',')} registrado com sucesso!${servico.valorRestante > 0 ? `\nRestante: R$ ${servico.valorRestante.toFixed(2).replace('.', ',')}` : '\nPagamento completo!'}`);
                } else {
                    alert('Valor inválido! O pagamento deve ser maior que zero e não pode exceder o valor restante.');
                }
            }
        }

        function marcarPago(id) {
            const servico = servicos.find(s => s.id === id);
            if (servico.valorRestante > 0) {
                servico.valorPago = servico.valorTotal;
                servico.valorRestante = 0;
                servico.pago = true;
                salvarDados();
                atualizarListaServicos();
                atualizarFinanceiro();
                alert('Pagamento completo registrado com sucesso!');
            }
        }

        function adicionarNovoTipoServico() {
            const novoTipo = prompt('Digite o nome do novo tipo de serviço:');
            
            if (novoTipo && novoTipo.trim()) {
                const tipoLimpo = novoTipo.trim();
                
                // Verificar se já existe
                if (!tiposServico.includes(tipoLimpo)) {
                    tiposServico.push(tipoLimpo);
                    salvarDados();
                    atualizarTiposServico();
                    
                    // Selecionar automaticamente o novo tipo
                    document.getElementById('tipo-servico').value = tipoLimpo;
                    
                    alert('Novo tipo de serviço adicionado com sucesso!');
                } else {
                    alert('Este tipo de serviço já existe!');
                }
            }
        }

        function inicializarTiposServico() {
            // Tipos padrão que sempre devem estar disponíveis
            const tiposPadrao = [
                'Limpeza de Túmulo',
                'Construção de Túmulo',
                'Reforma de Túmulo',
                'Colocação de Placa',
                'Jardinagem',
                'Pintura',
                'Manutenção Geral',
                'Massa Batida'
            ];
            
            // Garantir que tiposServico seja um array
            if (!Array.isArray(tiposServico)) {
                tiposServico = [];
            }
            
            // Adicionar tipos padrão que não existem ainda
            tiposPadrao.forEach(tipoPadrao => {
                if (!tiposServico.includes(tipoPadrao)) {
                    tiposServico.push(tipoPadrao);
                }
            });
            
            // Salvar sempre que adicionar novos tipos
            salvarDados();
        }

        function atualizarTiposServico() {
            const select = document.getElementById('tipo-servico');
            
            if (!select) {
                console.error('Elemento tipo-servico não encontrado');
                return;
            }
            
            // Garantir que tiposServico seja um array válido
            if (!Array.isArray(tiposServico) || tiposServico.length === 0) {
                inicializarTiposServico();
            }
            
            select.innerHTML = '<option value="">Selecione um tipo de serviço</option>' +
                tiposServico.map(tipo => `
                    <option value="${tipo}">${tipo}</option>
                `).join('');
        }

        function buscarClienteExistente() {
            const busca = document.getElementById('busca-cliente-form').value.toLowerCase();
            const resultados = document.getElementById('resultados-busca');
            
            if (busca.length < 2) {
                resultados.innerHTML = '';
                return;
            }
            
            const clientesEncontrados = clientes.filter(cliente => 
                cliente.nome.toLowerCase().includes(busca) ||
                cliente.falecido.toLowerCase().includes(busca) ||
                cliente.telefone.includes(busca)
            );
            
            if (clientesEncontrados.length === 0) {
                resultados.innerHTML = '<p class="text-gray-500 text-sm p-2">Nenhum cliente encontrado</p>';
                return;
            }
            
            resultados.innerHTML = clientesEncontrados.map(cliente => `
                <div class="bg-white border border-gray-200 rounded p-3 mb-2 cursor-pointer hover:bg-gray-50" onclick="selecionarCliente(${cliente.id})">
                    <div class="font-medium text-gray-800">${cliente.nome}</div>
                    <div class="text-sm text-gray-600">Falecido: ${cliente.falecido}</div>
                    <div class="text-sm text-gray-500">Tel: ${cliente.telefone} | Quadra: ${cliente.quadra} | Lote: ${cliente.lote}</div>
                </div>
            `).join('');
        }

        function selecionarCliente(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            
            if (cliente) {
                // Preencher formulário com dados do cliente
                document.getElementById('nome').value = cliente.nome;
                document.getElementById('telefone').value = cliente.telefone;
                document.getElementById('quadra').value = cliente.quadra;
                document.getElementById('lote').value = cliente.lote;
                document.getElementById('falecido').value = cliente.falecido;
                
                // Marcar que é um cliente existente
                document.getElementById('cliente-form').dataset.clienteId = clienteId;
                
                // Se tem dados de nota fiscal, preencher também
                if (cliente.notaFiscal && cliente.endereco) {
                    document.getElementById('nota-fiscal').checked = true;
                    toggleNotaFiscal();
                    document.getElementById('cep').value = cliente.endereco.cep;
                    document.getElementById('logradouro').value = cliente.endereco.logradouro;
                    document.getElementById('numero').value = cliente.endereco.numero;
                    document.getElementById('bairro').value = cliente.endereco.bairro;
                    document.getElementById('cidade').value = cliente.endereco.cidade;
                    document.getElementById('cpf').value = cliente.endereco.cpf;
                    document.getElementById('rg').value = cliente.endereco.rg;
                }
                
                // Limpar busca
                document.getElementById('busca-cliente-form').value = '';
                document.getElementById('resultados-busca').innerHTML = '';
                
                // Mostrar indicação visual
                document.getElementById('busca-cliente-form').placeholder = `Cliente selecionado: ${cliente.nome}`;
                
                alert(`Cliente "${cliente.nome}" selecionado! Os dados foram preenchidos automaticamente.`);
            }
        }

        function limparFormulario() {
            document.getElementById('cliente-form').reset();
            document.getElementById('cliente-form').removeAttribute('data-cliente-id');
            document.getElementById('campos-nf').classList.add('hidden');
            document.getElementById('prazo-personalizado').classList.add('hidden');
            document.getElementById('pagamento-parcelado').classList.add('hidden');
            document.getElementById('pagamento-avista').classList.remove('hidden');
            document.getElementById('valor-restante').value = '';
            document.getElementById('data-entrega-calculada').value = '';
            document.getElementById('busca-cliente-form').value = '';
            document.getElementById('busca-cliente-form').placeholder = 'Digite o nome do cliente ou falecido...';
            document.getElementById('resultados-busca').innerHTML = '';
            
            // Limpar serviços temporários
            servicosTemporarios = [];
            atualizarListaServicosAdicionados();
            atualizarValorTotalServicos();
            
            // Resetar forma de pagamento
            document.querySelector('input[name="forma-pagamento"][value="avista"]').checked = true;
        }

        function salvarDados() {
            localStorage.setItem('clientes', JSON.stringify(clientes));
            localStorage.setItem('servicos', JSON.stringify(servicos));
            localStorage.setItem('tiposServico', JSON.stringify(tiposServico));
            localStorage.setItem('proximoIdCliente', proximoIdCliente);
            localStorage.setItem('proximoIdServico', proximoIdServico);
        }

        function editarCliente(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            if (!cliente) return;
            
            // Criar formulário de edição em modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-96 overflow-y-auto">
                    <h3 class="text-lg font-bold mb-4">Editar Cliente</h3>
                    <form id="form-editar-cliente">
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">Nome do Cliente</label>
                                <input type="text" id="edit-nome" value="${cliente.nome}" class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Telefone</label>
                                <input type="tel" id="edit-telefone" value="${cliente.telefone}" class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Quadra</label>
                                    <input type="text" id="edit-quadra" value="${cliente.quadra}" class="w-full px-3 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Lote</label>
                                    <input type="text" id="edit-lote" value="${cliente.lote}" class="w-full px-3 py-2 border rounded-lg">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Nome do Falecido</label>
                                <input type="text" id="edit-falecido" value="${cliente.falecido}" class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                        <div class="flex space-x-3 mt-6">
                            <button type="submit" class="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                                Salvar Alterações
                            </button>
                            <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Event listener para salvar
            document.getElementById('form-editar-cliente').addEventListener('submit', function(e) {
                e.preventDefault();
                
                cliente.nome = document.getElementById('edit-nome').value;
                cliente.telefone = document.getElementById('edit-telefone').value;
                cliente.quadra = document.getElementById('edit-quadra').value;
                cliente.lote = document.getElementById('edit-lote').value;
                cliente.falecido = document.getElementById('edit-falecido').value;
                
                salvarDados();
                atualizarListaServicos();
                atualizarResumoRapido();
                modal.remove();
                
                alert('Cliente atualizado com sucesso!');
            });
        }

        function excluirCliente(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            const servicosCliente = servicos.filter(s => s.clienteId === clienteId);
            
            if (!cliente) return;
            
            const confirmacao = confirm(`⚠️ ATENÇÃO: EXCLUSÃO PERMANENTE ⚠️\n\nTem certeza que deseja EXCLUIR PERMANENTEMENTE o cliente "${cliente.nome}"?\n\nIsto irá remover DEFINITIVAMENTE:\n✗ O cliente e todos os seus dados\n✗ ${servicosCliente.length} serviço(s) associado(s)\n✗ Todo o histórico financeiro\n\n🚨 ESTA AÇÃO NÃO PODE SER DESFEITA! 🚨\n\nDigite "EXCLUIR" para confirmar:`);
            
            if (confirmacao) {
                const confirmacaoFinal = prompt(`Para confirmar a exclusão permanente do cliente "${cliente.nome}", digite exatamente: EXCLUIR`);
                
                if (confirmacaoFinal === "EXCLUIR") {
                    // Remover cliente
                    const indexCliente = clientes.findIndex(c => c.id === clienteId);
                    if (indexCliente > -1) {
                        clientes.splice(indexCliente, 1);
                    }
                    
                    // Remover todos os serviços do cliente
                    servicosCliente.forEach(servico => {
                        const indexServico = servicos.findIndex(s => s.id === servico.id);
                        if (indexServico > -1) {
                            servicos.splice(indexServico, 1);
                        }
                    });
                    
                    salvarDados();
                    atualizarListaClientesGeral();
                    atualizarListaServicos();
                    atualizarFinanceiro();
                    atualizarResumoRapido();
                    
                    // Voltar à lista se estava vendo detalhes
                    voltarListaClientes();
                    
                    alert(`✅ Cliente "${cliente.nome}" foi excluído permanentemente.\n\n📊 Resumo da exclusão:\n• Cliente removido\n• ${servicosCliente.length} serviço(s) removido(s)\n• Histórico financeiro limpo`);
                } else {
                    alert('❌ Exclusão cancelada. O texto de confirmação não confere.');
                }
            }
        }

        function cancelarCliente(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            const servicosCliente = servicos.filter(s => s.clienteId === clienteId);
            
            if (!cliente) return;
            
            const confirmacao = confirm(`Tem certeza que deseja cancelar o cliente "${cliente.nome}"?\n\nIsto irá remover:\n- O cliente\n- ${servicosCliente.length} serviço(s) associado(s)\n\nEsta ação não pode ser desfeita!`);
            
            if (confirmacao) {
                // Remover cliente
                const indexCliente = clientes.findIndex(c => c.id === clienteId);
                if (indexCliente > -1) {
                    clientes.splice(indexCliente, 1);
                }
                
                // Remover todos os serviços do cliente
                servicosCliente.forEach(servico => {
                    const indexServico = servicos.findIndex(s => s.id === servico.id);
                    if (indexServico > -1) {
                        servicos.splice(indexServico, 1);
                    }
                });
                
                salvarDados();
                atualizarListaServicos();
                atualizarFinanceiro();
                atualizarResumoRapido();
                
                alert(`Cliente "${cliente.nome}" e todos os seus serviços foram cancelados.`);
            }
        }

        function editarServico(servicoId) {
            const servico = servicos.find(s => s.id === servicoId);
            const cliente = clientes.find(c => c.id === servico.clienteId);
            
            if (!servico) return;
            
            // Criar formulário de edição em modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-96 overflow-y-auto">
                    <h3 class="text-lg font-bold mb-4">Editar Serviço - ${cliente.nome}</h3>
                    <form id="form-editar-servico">
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">Tipo de Serviço</label>
                                <input type="text" id="edit-descricao" value="${servico.descricao}" class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Data do Serviço</label>
                                <input type="date" id="edit-data-inicio" value="${servico.dataInicio}" class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Prazo (dias)</label>
                                <input type="number" id="edit-prazo-dias" value="${servico.prazoDias}" min="1" class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Valor Total (R$)</label>
                                <input type="number" id="edit-valor-total" value="${servico.valorTotal}" step="0.01" min="0" class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Status</label>
                                <select id="edit-status" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="pendente" ${servico.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                    <option value="em-andamento" ${servico.status === 'em-andamento' ? 'selected' : ''}>Em Andamento</option>
                                    <option value="concluido" ${servico.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Observações do Pagamento</label>
                                <textarea id="edit-obs-pagamento" rows="2" class="w-full px-3 py-2 border rounded-lg">${servico.observacoesPagamento || ''}</textarea>
                            </div>
                        </div>
                        <div class="flex space-x-3 mt-6">
                            <button type="submit" class="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                                Salvar Alterações
                            </button>
                            <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Event listener para salvar
            document.getElementById('form-editar-servico').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const novoValorTotal = parseFloat(document.getElementById('edit-valor-total').value);
                const valorPagoAtual = servico.valorPago;
                
                servico.descricao = document.getElementById('edit-descricao').value;
                servico.dataInicio = document.getElementById('edit-data-inicio').value;
                servico.prazoDias = parseInt(document.getElementById('edit-prazo-dias').value);
                servico.valorTotal = novoValorTotal;
                servico.status = document.getElementById('edit-status').value;
                servico.observacoesPagamento = document.getElementById('edit-obs-pagamento').value;
                
                // Recalcular prazo de entrega
                const dataInicio = new Date(servico.dataInicio);
                const dataEntrega = new Date(dataInicio);
                dataEntrega.setDate(dataEntrega.getDate() + servico.prazoDias);
                servico.prazoEntrega = dataEntrega.toISOString().split('T')[0];
                
                // Recalcular valor restante
                servico.valorRestante = novoValorTotal - valorPagoAtual;
                if (servico.valorRestante < 0) servico.valorRestante = 0;
                servico.pago = servico.valorRestante === 0;
                
                salvarDados();
                atualizarListaServicos();
                atualizarFinanceiro();
                atualizarResumoRapido();
                modal.remove();
                
                alert('Serviço atualizado com sucesso!');
            });
        }

        function cancelarServico(servicoId) {
            const servico = servicos.find(s => s.id === servicoId);
            const cliente = clientes.find(c => c.id === servico.clienteId);
            
            if (!servico) return;
            
            const confirmacao = confirm(`Tem certeza que deseja cancelar este serviço?\n\nCliente: ${cliente.nome}\nServiço: ${servico.descricao}\nValor: R$ ${servico.valorTotal.toFixed(2).replace('.', ',')}\n\nEsta ação não pode ser desfeita!`);
            
            if (confirmacao) {
                const indexServico = servicos.findIndex(s => s.id === servicoId);
                if (indexServico > -1) {
                    servicos.splice(indexServico, 1);
                }
                
                salvarDados();
                atualizarListaServicos();
                atualizarFinanceiro();
                atualizarResumoRapido();
                
                alert('Serviço cancelado com sucesso!');
            }
        }

        function mostrarClientesPendentes() {
            const servicosPendentes = servicos.filter(s => s.valorRestante > 0);
            
            if (servicosPendentes.length === 0) {
                alert('Não há pagamentos pendentes no momento!');
                return;
            }
            
            // Criar modal com lista de clientes pendentes
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                            Pagamentos Pendentes
                        </h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="space-y-3">
                        ${servicosPendentes.map(servico => {
                            const cliente = clientes.find(c => c.id === servico.clienteId);
                            const porcentagemPaga = (servico.valorPago / servico.valorTotal) * 100;
                            
                            return `
                                <div class="border border-yellow-200 rounded-lg p-4 bg-yellow-50">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800">${cliente ? cliente.nome : 'Cliente não encontrado'}</h4>
                                            <p class="text-sm text-gray-600">${servico.descricao}</p>
                                            <p class="text-xs text-gray-500">Tel: ${cliente ? cliente.telefone : 'N/A'}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-lg font-bold text-red-600">R$ ${servico.valorRestante.toFixed(2).replace('.', ',')}</p>
                                            <p class="text-sm text-gray-600">de R$ ${servico.valorTotal.toFixed(2).replace('.', ',')}</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Barra de progresso -->
                                    <div class="mb-3">
                                        <div class="flex justify-between text-xs text-gray-600 mb-1">
                                            <span>Progresso do pagamento</span>
                                            <span>${porcentagemPaga.toFixed(0)}%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-green-500 h-2 rounded-full" style="width: ${porcentagemPaga}%"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex flex-wrap gap-2">
                                        <button onclick="adicionarPagamento(${servico.clienteId}); this.closest('.fixed').remove();" 
                                                class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition duration-200">
                                            <i class="fas fa-money-bill mr-1"></i>Receber Pagamento
                                        </button>
                                        <a href="https://wa.me/55${cliente ? cliente.telefone.replace(/\D/g, '') : ''}?text=Olá%20${cliente ? encodeURIComponent(cliente.nome) : ''}!%20Temos%20um%20valor%20pendente%20de%20R$%20${servico.valorRestante.toFixed(2).replace('.', ',')}%20referente%20ao%20serviço%20${encodeURIComponent(servico.descricao)}.%20Quando%20podemos%20acertar?" 
                                           target="_blank" rel="noopener noreferrer"
                                           class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition duration-200">
                                            <i class="fab fa-whatsapp mr-1"></i>Cobrar via WhatsApp
                                        </a>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-gray-700">Total a Receber:</span>
                            <span class="text-xl font-bold text-red-600">
                                R$ ${servicosPendentes.reduce((sum, s) => sum + s.valorRestante, 0).toFixed(2).replace('.', ',')}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function carregarDados() {
            try {
                const clientesSalvos = localStorage.getItem('clientes');
                const servicosSalvos = localStorage.getItem('servicos');
                const tiposSalvos = localStorage.getItem('tiposServico');
                
                if (clientesSalvos) {
                    clientes = JSON.parse(clientesSalvos);
                }
                if (servicosSalvos) {
                    servicos = JSON.parse(servicosSalvos);
                }
                if (tiposSalvos) {
                    const tiposCarregados = JSON.parse(tiposSalvos);
                    if (Array.isArray(tiposCarregados)) {
                        tiposServico = tiposCarregados;
                    }
                }
                
                proximoIdCliente = parseInt(localStorage.getItem('proximoIdCliente')) || 1;
                proximoIdServico = parseInt(localStorage.getItem('proximoIdServico')) || 1;
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                // Em caso de erro, inicializar com arrays vazios
                clientes = [];
                servicos = [];
                tiposServico = [];
            }
        }
    </script>
    <script>
    // ... seu código de conexão com o Firebase e variáveis ...

    document.addEventListener('DOMContentLoaded', function() {
        loadThemePreference();

        // ##### NOVO: CÓDIGO PARA REGISTRAR O SERVICE WORKER #####
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('Service Worker registrado com sucesso:', registration);
                })
                .catch(error => {
                    console.log('Falha ao registrar o Service Worker:', error);
                });
        }
        // ##### FIM DO CÓDIGO DE REGISTRO #####

        // ... resto do seu código de event listeners e chamada ao carregarDadosDoFirestore() ...
    });

    // ... resto do seu script ...
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'984f68e282df02f8',t:'MTc1ODg1NDU2NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>


